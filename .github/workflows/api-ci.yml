name: api-ci 

on:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v3

      - name: Create Properties Files
        run: |
          touch ./api/src/main/resources/application.properties
          echo "auth.whitelisted-emails=${{ secrets.API_AUTH_WHITELISTED_EMAILS }}" >> ./api/src/main/resources/application.properties
          echo "aws.access-key=${{ secrets.API_AWS_ACCESS_KEY }}" >> ./api/src/main/resources/application.properties
          echo "aws.secret-key=${{ secrets.API_AWS_SECRET_KEY }}" >> ./api/src/main/resources/application.properties
          echo "aws.region=us-east-2" >> ./api/src/main/resources/application.properties
          echo "aws.s3.buckets.blog=personal-website-api-bucket-prod" >> ./api/src/main/resources/application.properties
          echo "security.jwt.secret-key=${{ secrets.API_SECURITY_JWT_SECRET_KEY }}" >> ./api/src/main/resources/application.properties
          echo "security.cors.allowed-origins=${{ secrets.API_SECURITY_CORS_ALLOWED_ORIGINS }}" >> ./api/src/main/resources/application.properties
          echo "security.cors.allowed-methods=\"GET,POST,PUT,DELETE,OPTIONS\"" >> ./api/src/main/resources/application.properties
          echo "security.cors.allowed-headers=\"Authorization,Content-Type\"" >> ./api/src/main/resources/application.properties
          echo "security.cors.exposed-headers=\"Authorization,Content-Type\"" >> ./api/src/main/resources/application.properties
          echo "spring.application.name=personal-website-api" >> ./api/src/main/resources/application.properties
          echo "spring.datasource.url=${{ secrets.API_SPRING_TEST_DATASOURCE_URL }}" >> ./api/src/main/resources/application.properties
          echo "spring.datasource.username=${{ secrets.API_SPRING_DATASOURCE_USERNAME }}" >> ./api/src/main/resources/application.properties
          echo "spring.datasource.password=${{ secrets.API_SPRING_DATASOURCE_PASSWORD }}" >> ./api/src/main/resources/application.properties
          echo "spring.jpa.hibernate.ddl-auto=update" >> ./api/src/main/resources/application.properties
          echo "spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect" >> ./api/src/main/resources/application.properties
          touch ./api/src/test/resources/application-it.properties
          echo "auth.whitelisted-emails=\"test@mail.com\"" >> ./api/src/test/resources/application-it.properties
          echo "aws.access-key=${{ secrets.API_AWS_ACCESS_KEY }}" >> ./api/src/test/resources/application-it.properties
          echo "aws.secret-key=${{ secrets.API_AWS_SECRET_KEY }}" >> ./api/src/test/resources/application-it.properties
          echo "aws.region=us-east-2" >> ./api/src/test/resources/application-it.properties
          echo "aws.s3.buckets.blog=personal-website-api-bucket-test" >> ./api/src/test/resources/application-it.properties
          echo "security.jwt.secret-key=${{ secrets.API_SECURITY_JWT_SECRET_KEY }}" >> ./api/src/test/resources/application-it.properties
          echo "security.cors.allowed-origins=\"*\"" >> ./api/src/test/resources/application-it.properties
          echo "security.cors.allowed-methods=\"GET,POST,PUT,DELETE,OPTIONS\"" >> ./api/src/test/resources/application-it.properties
          echo "security.cors.allowed-headers=\"Authorization,Content-Type\"" >> ./api/src/test/resources/application-it.properties
          echo "security.cors.exposed-headers=\"Authorization,Content-Type\"" >> ./api/src/test/resources/application-it.properties
          echo "spring.application.name=personal-website-api" >> ./api/src/test/resources/application-it.properties
          echo "spring.datasource.url=${{ secrets.API_SPRING_TEST_DATASOURCE_URL }}" >> ./api/src/test/resources/application-it.properties
          echo "spring.datasource.username=${{ secrets.API_SPRING_DATASOURCE_USERNAME }}" >> ./api/src/test/resources/application-it.properties
          echo "spring.datasource.password=${{ secrets.API_SPRING_DATASOURCE_PASSWORD }}" >> ./api/src/test/resources/application-it.properties
          echo "spring.datasource.driver-class-name=org.postgresql.Driver" >> ./api/src/test/resources/application-it.properties
          echo "spring.jpa.hibernate.ddl-auto=update" >> ./api/src/test/resources/application-it.properties
          echo "spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect" >> ./api/src/test/resources/application-it.properties

      - name: Build & Test API 
        working-directory: ./api
        run: docker build . -t michaelyi/personal-website-api:latest